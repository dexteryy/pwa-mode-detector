<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PWA 模式检测器</title>
    <!-- 图标作为 data URI -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMzQjgyRjYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1kZXZpY2VzIj48cmVjdCB3aWR0aD0iMTAiIGhlaWdodD0iMTQiIHg9IjEyIiB5PSI4IiByeD0iMiIvPjxwYXRoIGQ9Ik0yIDE4aDEwVjZIMmEyIDIgMCAwIDAtMiAydjggYTIgMiAwIDAgMCAyIDJaIi8+PHBhdGggZD0iTTYgMTNoMCIvPjwvc3ZnPg==" />
    <meta name="theme-color" content="#3B82F6" />
    
    <!-- PWA manifest 作为 data URI -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlBXQSBNb2RlIERldGVjdG9yIiwKICAic2hvcnRfbmFtZSI6ICJQd2FEZXRlY3RvciIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMzQjgyRjYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3VpLWF2YXRhcnMuY29tL2FwaS8/bmFtZT1QV0EmYmFja2dyb3VuZD0zQjgyRjYmY29sb3I9ZmZmIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">
    
    <!-- 引入谷歌字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
      /* 基本样式 */
      :root {
        --color-primary: #3B82F6;
        --color-success: #22C55E;
        --color-warning: #F59E0B;
        --color-info: #0EA5E9;
        --color-dark: #1F2937;
        --color-gray: #F3F4F6;
        --color-white: #FFFFFF;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --radius: 0.375rem;
      }
      
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Inter', sans-serif;
        background-color: var(--color-gray);
        color: var(--color-dark);
        line-height: 1.5;
      }
      
      /* 布局 */
      .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
      }
      
      .header {
        background-color: var(--color-primary);
        color: var(--color-white);
        padding: 1rem 0;
        box-shadow: var(--shadow-md);
      }
      
      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .title-wrapper {
        display: flex;
        align-items: center;
      }
      
      .title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-left: 0.5rem;
      }
      
      .refresh-btn {
        background-color: var(--color-white);
        color: var(--color-primary);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
      }
      
      .refresh-btn:hover {
        background-color: rgba(255, 255, 255, 0.9);
      }
      
      .main {
        padding: 2rem 0;
      }
      
      .card {
        background-color: var(--color-white);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        margin-bottom: 2rem;
      }
      
      .status-card {
        border-left: 4px solid var(--color-warning);
        display: flex;
        align-items: flex-start;
      }
      
      .status-icon {
        font-size: 2rem;
        margin-right: 1rem;
        color: var(--color-warning);
      }
      
      .status-content h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }
      
      .status-content p {
        color: #6B7280;
      }
      
      .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
      }
      
      .section-title .material-icons {
        margin-right: 0.5rem;
      }
      
      .detection-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 1rem;
      }
      
      @media (min-width: 768px) {
        .detection-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      
      .detection-item {
        border: 1px solid #E5E7EB;
        border-radius: var(--radius);
        padding: 1rem;
        background-color: #F9FAFB;
      }
      
      .detection-item.active {
        background-color: #ECFDF5;
        border-color: var(--color-success);
      }
      
      .detection-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      
      .detection-name {
        font-weight: 500;
      }
      
      .status-indicator {
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 50%;
        background-color: #D1D5DB;
      }
      
      .status-indicator.active {
        background-color: var(--color-success);
      }
      
      .status-text {
        font-size: 0.875rem;
        color: #6B7280;
      }
      
      .status-text.active {
        color: var(--color-success);
        font-weight: 500;
      }
      
      .info-list {
        list-style-type: disc;
        padding-left: 1.5rem;
        margin-top: 0.5rem;
      }
      
      .info-list li {
        margin-bottom: 0.5rem;
      }
      
      .info-list strong {
        font-weight: 600;
      }
      
      .footer {
        background-color: var(--color-dark);
        color: var(--color-white);
        padding: 1rem 0;
        margin-top: 2rem;
        text-align: center;
        font-size: 0.875rem;
      }
      
      .user-agent {
        color: #9CA3AF;
        font-size: 0.75rem;
      }
      
      .install-btn {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background-color: var(--color-primary);
        color: var(--color-white);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        box-shadow: var(--shadow-lg);
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
      }
      
      .install-btn:hover {
        background-color: #2563EB;
      }
      
      .install-btn .material-icons {
        margin-right: 0.25rem;
      }
      
      .hidden {
        display: none;
      }
      
      /* 动画 */
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      
      .animate-spin {
        animation: spin 0.5s linear;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- 页面头部 -->
      <header class="header">
        <div class="container header-content">
          <div class="title-wrapper">
            <span class="material-icons">devices</span>
            <h1 class="title">PWA 模式检测器</h1>
          </div>
          <button 
            id="refreshButton"
            class="refresh-btn"
            aria-label="刷新检测"
          >
            <span class="material-icons">refresh</span>
          </button>
        </div>
      </header>

      <!-- 主要内容 -->
      <main class="main container">
        <!-- 状态卡片 -->
        <div id="statusCard" class="card status-card">
          <span id="statusIcon" class="material-icons status-icon"></span>
          <div class="status-content">
            <h2 id="statusText"></h2>
            <p id="statusPrompt"></p>
          </div>
        </div>

        <!-- 检测详情卡片 -->
        <div class="card">
          <h2 class="section-title">
            <span class="material-icons">info</span>
            检测详情
          </h2>
          
          <div id="detectionCards" class="detection-grid">
            <!-- 检测卡片将在JavaScript中动态添加 -->
          </div>
        </div>

        <!-- 信息卡片 -->
        <div class="card">
          <h2 class="section-title">
            <span class="material-icons">help_outline</span>
            关于 PWA 模式
          </h2>
          <div>
            <p>PWA（渐进式 Web 应用）可以在不同的显示模式下运行：</p>
            <ul class="info-list">
              <li><strong>独立窗口 (standalone)：</strong>应用在没有浏览器界面的独立窗口中运行，类似于原生应用</li>
              <li><strong>浏览器 (browser)：</strong>应用在常规浏览器标签页中运行</li>
              <li><strong>最小界面 (minimal-ui)：</strong>应用在带有最小浏览器控件的窗口中运行</li>
              <li><strong>全屏 (fullscreen)：</strong>应用占据整个屏幕，没有任何浏览器界面</li>
            </ul>
          </div>
        </div>
      </main>

      <!-- 页脚 -->
      <footer class="footer">
        <div class="container">
          <p>PWA 模式检测器 | 检测环境：<span id="userAgent" class="user-agent"></span></p>
        </div>
      </footer>

      <!-- 安装PWA的按钮（仅在可安装时显示） -->
      <div id="installButton" class="hidden">
        <button class="install-btn">
          <span class="material-icons">get_app</span>
          安装应用
        </button>
      </div>
    </div>

    <!-- 应用脚本 -->
    <script>
      // 定义显示模式数据
      const displayModes = [
        {
          name: "standalone",
          displayName: "独立窗口模式",
          description: "应用在没有浏览器界面的独立窗口中运行"
        },
        {
          name: "browser",
          displayName: "浏览器模式",
          description: "应用在常规浏览器标签页中运行"
        },
        {
          name: "minimal-ui",
          displayName: "最小界面模式", 
          description: "应用在带有最小浏览器控件的窗口中运行"
        },
        {
          name: "fullscreen",
          displayName: "全屏模式",
          description: "应用占据整个屏幕，没有任何浏览器界面"
        }
      ];

      // DOM元素引用
      const statusCard = document.getElementById('statusCard');
      const statusIcon = document.getElementById('statusIcon');
      const statusText = document.getElementById('statusText');
      const statusPrompt = document.getElementById('statusPrompt');
      const detectionCards = document.getElementById('detectionCards');
      const userAgentElement = document.getElementById('userAgent');
      const installButton = document.getElementById('installButton');
      const refreshButton = document.getElementById('refreshButton');

      // 应用状态
      let currentMode = "browser";
      let isInstallable = false;
      let deferredPrompt = null;

      // 检测当前显示模式
      function checkDisplayMode() {
        // 默认为浏览器模式
        let detectedMode = "browser";
        
        // 检查每种显示模式
        for (const mode of displayModes) {
          const isActive = window.matchMedia(`(display-mode: ${mode.name})`).matches;
          
          // 特殊处理iOS的独立模式
          const isIOSStandalone = 
            mode.name === "standalone" && 
            window.navigator.standalone === true;
            
          if (isActive || isIOSStandalone) {
            detectedMode = mode.name;
            break; // 使用第一个匹配的模式
          }
        }
        
        currentMode = detectedMode;
        updateUI();
      }

      // 更新用户界面
      function updateUI() {
        // 更新状态卡片
        if (currentMode === "standalone") {
          statusCard.style.borderLeftColor = "var(--color-success)";
          statusIcon.style.color = "var(--color-success)";
          statusIcon.textContent = "check_circle";
          statusText.textContent = "当前运行模式：PWA独立窗口（standalone）";
          statusPrompt.textContent = "应用已在独立窗口模式下运行";
        } else if (currentMode === "minimal-ui") {
          statusCard.style.borderLeftColor = "var(--color-info)";
          statusIcon.style.color = "var(--color-info)";
          statusIcon.textContent = "view_compact";
          statusText.textContent = "当前运行模式：最小界面（minimal-ui）";
          statusPrompt.textContent = "您可以安装此应用以体验完整的独立窗口模式";
        } else if (currentMode === "fullscreen") {
          statusCard.style.borderLeftColor = "var(--color-info)";
          statusIcon.style.color = "var(--color-info)";
          statusIcon.textContent = "fullscreen";
          statusText.textContent = "当前运行模式：全屏（fullscreen）";
          statusPrompt.textContent = "应用已在全屏模式下运行";
        } else {
          statusCard.style.borderLeftColor = "var(--color-warning)";
          statusIcon.style.color = "var(--color-warning)";
          statusIcon.textContent = "public";
          statusText.textContent = "当前运行模式：浏览器标签页（browser）";
          statusPrompt.textContent = isInstallable 
            ? "您可以安装此应用以体验 PWA 独立窗口模式"
            : "您的浏览器不支持安装 PWA 应用";
        }

        // 清空并重新填充检测卡片
        detectionCards.innerHTML = '';
        displayModes.forEach(mode => {
          const isActive = mode.name === currentMode;
          const card = document.createElement('div');
          
          card.className = isActive
            ? "detection-item active"
            : "detection-item";
            
          card.innerHTML = `
            <div class="detection-header">
              <h3 class="detection-name">${mode.displayName} (${mode.name})</h3>
              <span class="status-indicator ${isActive ? 'active' : ''}"></span>
            </div>
            <p class="status-text ${isActive ? 'active' : ''}">
              ${isActive ? "已启用" : "未启用"}
            </p>
          `;
          
          detectionCards.appendChild(card);
        });

        // 更新用户代理信息
        userAgentElement.textContent = navigator.userAgent;

        // 更新安装按钮可见性
        installButton.className = isInstallable ? "" : "hidden";
      }

      // 初始化和事件监听
      function init() {
        // 显示用户代理
        userAgentElement.textContent = navigator.userAgent;
        
        // 初始检测
        checkDisplayMode();
        
        // 监听每种显示模式的变化
        displayModes.forEach(mode => {
          const mediaQuery = window.matchMedia(`(display-mode: ${mode.name})`);
          
          // 使用现代浏览器的addEventListener
          mediaQuery.addEventListener("change", (e) => {
            if (e.matches) {
              checkDisplayMode();
            }
          });
        });
        
        // 监听beforeinstallprompt事件
        window.addEventListener("beforeinstallprompt", (e) => {
          // 阻止Chrome 67+自动显示安装提示
          e.preventDefault();
          // 保存事件以便稍后触发
          deferredPrompt = e;
          isInstallable = true;
          updateUI();
        });
        
        // 应用安装后隐藏安装按钮
        window.addEventListener("appinstalled", () => {
          deferredPrompt = null;
          isInstallable = false;
          updateUI();
        });
        
        // 可见性变化时也检查
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") {
            checkDisplayMode();
          }
        });

        // 刷新按钮点击事件
        refreshButton.addEventListener('click', () => {
          refreshButton.classList.add('animate-spin');
          checkDisplayMode();
          setTimeout(() => {
            refreshButton.classList.remove('animate-spin');
          }, 500);
        });

        // 安装按钮点击事件
        installButton.querySelector('button').addEventListener('click', () => {
          if (deferredPrompt) {
            // 显示安装提示
            deferredPrompt.prompt();
            
            // 等待用户响应提示
            deferredPrompt.userChoice.then((choiceResult) => {
              if (choiceResult.outcome === "accepted") {
                console.log("用户接受了安装提示");
              } else {
                console.log("用户拒绝了安装提示");
              }
              // 清除保存的提示
              deferredPrompt = null;
              isInstallable = false;
              updateUI();
            });
          }
        });
      }

      // 在页面加载完成后初始化
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>