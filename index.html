<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PWA 模式检测器</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMzQjgyRjYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBjbGFzcz0ibHVjaWRlIGx1Y2lkZS1kZXZpY2VzIj48cmVjdCB3aWR0aD0iMTAiIGhlaWdodD0iMTQiIHg9IjEyIiB5PSI4IiByeD0iMiIvPjxwYXRoIGQ9Ik0yIDE4aDEwVjZIMmEyIDIgMCAwIDAtMiAydjggYTIgMiAwIDAgMCAyIDJaIi8+PHBhdGggZD0iTTYgMTNoMCIvPjwvc3ZnPg==" />
    <meta name="theme-color" content="#3B82F6" />
    
    <!-- Web app manifest for PWA support -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlBXQSBNb2RlIERldGVjdG9yIiwKICAic2hvcnRfbmFtZSI6ICJQd2FEZXRlY3RvciIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMzQjgyRjYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3VpLWF2YXRhcnMuY29tL2FwaS8/bmFtZT1QV0EmYmFja2dyb3VuZD0zQjgyRjYmY29sb3I9ZmZmIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">
    
    <!-- 引入字体和图标 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Tailwind CDN (开发环境使用，生产环境建议使用构建工具) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#3B82F6',
              success: '#22C55E',
              warning: '#F59E0B',
              info: '#0EA5E9',
              dark: '#1F2937',
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          },
        },
      }
    </script>
    
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #F3F4F6;
      }
    </style>
  </head>
  <body>
    <div id="app" class="bg-gray-100 font-sans min-h-screen">
      <!-- 页面头部 -->
      <header class="bg-primary text-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
          <div class="flex items-center">
            <span class="material-icons mr-2">devices</span>
            <h1 class="text-xl font-semibold">PWA 模式检测器</h1>
          </div>
          <button 
            id="refreshButton"
            class="bg-white text-primary p-2 rounded-full hover:bg-blue-50 transition-colors" 
            aria-label="刷新检测"
          >
            <span class="material-icons">refresh</span>
          </button>
        </div>
      </header>

      <!-- 主要内容 -->
      <main class="container mx-auto px-4 py-8">
        <!-- 状态卡片 -->
        <div id="statusCard" class="bg-white rounded-lg shadow-md p-6 mb-8 border-l-4">
          <div class="flex items-center mb-4">
            <span id="statusIcon" class="material-icons text-3xl mr-3"></span>
            <div>
              <h2 id="statusText" class="text-xl font-semibold text-dark"></h2>
              <p id="statusPrompt" class="text-gray-500"></p>
            </div>
          </div>
        </div>

        <!-- 检测详情卡片 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
          <h2 class="text-lg font-semibold text-dark mb-4 flex items-center">
            <span class="material-icons mr-2">info</span>
            检测详情
          </h2>
          
          <div id="detectionCards" class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <!-- 检测卡片将在JavaScript中动态添加 -->
          </div>
        </div>

        <!-- 信息卡片 -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-lg font-semibold text-dark mb-4 flex items-center">
            <span class="material-icons mr-2">help_outline</span>
            关于 PWA 模式
          </h2>
          <div class="prose text-gray-700">
            <p class="mb-3">PWA（渐进式 Web 应用）可以在不同的显示模式下运行：</p>
            <ul class="list-disc pl-5 space-y-2">
              <li><strong>独立窗口 (standalone)：</strong>应用在没有浏览器界面的独立窗口中运行，类似于原生应用</li>
              <li><strong>浏览器 (browser)：</strong>应用在常规浏览器标签页中运行</li>
              <li><strong>最小界面 (minimal-ui)：</strong>应用在带有最小浏览器控件的窗口中运行</li>
              <li><strong>全屏 (fullscreen)：</strong>应用占据整个屏幕，没有任何浏览器界面</li>
            </ul>
          </div>
        </div>
      </main>

      <!-- 页脚 -->
      <footer class="bg-dark text-white py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-sm">
          <p>PWA 模式检测器 | 检测环境：<span id="userAgent" class="text-gray-400 text-xs"></span></p>
        </div>
      </footer>

      <!-- 安装PWA的按钮（仅在可安装时显示） -->
      <div id="installButton" class="fixed bottom-4 right-4 hidden">
        <button 
          class="bg-primary text-white px-4 py-2 rounded-full shadow-lg hover:bg-blue-600 flex items-center"
        >
          <span class="material-icons mr-1">get_app</span>
          安装应用
        </button>
      </div>
    </div>

    <!-- 应用脚本 -->
    <script>
      // 定义显示模式数据
      const displayModes = [
        {
          name: "standalone",
          displayName: "独立窗口模式",
          description: "应用在没有浏览器界面的独立窗口中运行"
        },
        {
          name: "browser",
          displayName: "浏览器模式",
          description: "应用在常规浏览器标签页中运行"
        },
        {
          name: "minimal-ui",
          displayName: "最小界面模式", 
          description: "应用在带有最小浏览器控件的窗口中运行"
        },
        {
          name: "fullscreen",
          displayName: "全屏模式",
          description: "应用占据整个屏幕，没有任何浏览器界面"
        }
      ];

      // DOM元素引用
      const statusCard = document.getElementById('statusCard');
      const statusIcon = document.getElementById('statusIcon');
      const statusText = document.getElementById('statusText');
      const statusPrompt = document.getElementById('statusPrompt');
      const detectionCards = document.getElementById('detectionCards');
      const userAgentElement = document.getElementById('userAgent');
      const installButton = document.getElementById('installButton');
      const refreshButton = document.getElementById('refreshButton');

      // 应用状态
      let currentMode = "browser";
      let isInstallable = false;
      let deferredPrompt = null;

      // 检测当前显示模式
      function checkDisplayMode() {
        // 默认为浏览器模式
        let detectedMode = "browser";
        
        // 检查每种显示模式
        for (const mode of displayModes) {
          const isActive = window.matchMedia(`(display-mode: ${mode.name})`).matches;
          
          // 特殊处理iOS的独立模式
          const isIOSStandalone = 
            mode.name === "standalone" && 
            window.navigator.standalone === true;
            
          if (isActive || isIOSStandalone) {
            detectedMode = mode.name;
            break; // 使用第一个匹配的模式
          }
        }
        
        currentMode = detectedMode;
        updateUI();
      }

      // 更新用户界面
      function updateUI() {
        // 更新状态卡片
        if (currentMode === "standalone") {
          statusCard.className = "bg-white rounded-lg shadow-md p-6 mb-8 border-l-4 border-success";
          statusIcon.className = "material-icons text-3xl mr-3 text-success";
          statusIcon.textContent = "check_circle";
          statusText.textContent = "当前运行模式：PWA独立窗口（standalone）";
          statusPrompt.textContent = "应用已在独立窗口模式下运行";
        } else if (currentMode === "minimal-ui") {
          statusCard.className = "bg-white rounded-lg shadow-md p-6 mb-8 border-l-4 border-info";
          statusIcon.className = "material-icons text-3xl mr-3 text-info";
          statusIcon.textContent = "view_compact";
          statusText.textContent = "当前运行模式：最小界面（minimal-ui）";
          statusPrompt.textContent = "您可以安装此应用以体验完整的独立窗口模式";
        } else if (currentMode === "fullscreen") {
          statusCard.className = "bg-white rounded-lg shadow-md p-6 mb-8 border-l-4 border-info";
          statusIcon.className = "material-icons text-3xl mr-3 text-info";
          statusIcon.textContent = "fullscreen";
          statusText.textContent = "当前运行模式：全屏（fullscreen）";
          statusPrompt.textContent = "应用已在全屏模式下运行";
        } else {
          statusCard.className = "bg-white rounded-lg shadow-md p-6 mb-8 border-l-4 border-warning";
          statusIcon.className = "material-icons text-3xl mr-3 text-warning";
          statusIcon.textContent = "public";
          statusText.textContent = "当前运行模式：浏览器标签页（browser）";
          statusPrompt.textContent = isInstallable 
            ? "您可以安装此应用以体验 PWA 独立窗口模式"
            : "您的浏览器不支持安装 PWA 应用";
        }

        // 清空并重新填充检测卡片
        detectionCards.innerHTML = '';
        displayModes.forEach(mode => {
          const isActive = mode.name === currentMode;
          const card = document.createElement('div');
          
          card.className = isActive
            ? "border rounded-lg p-4 bg-green-50 border-success"
            : "border rounded-lg p-4 bg-gray-50";
            
          card.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-medium">${mode.displayName} (${mode.name})</h3>
              <span class="${isActive ? "inline-block w-3 h-3 rounded-full bg-success" : "inline-block w-3 h-3 rounded-full bg-gray-300"}"></span>
            </div>
            <p class="${isActive ? "text-sm text-success font-medium" : "text-sm text-gray-600"}">
              ${isActive ? "已启用" : "未启用"}
            </p>
          `;
          
          detectionCards.appendChild(card);
        });

        // 更新用户代理信息
        userAgentElement.textContent = navigator.userAgent;

        // 更新安装按钮可见性
        installButton.style.display = isInstallable ? "block" : "none";
      }

      // 初始化和事件监听
      function init() {
        // 显示用户代理
        userAgentElement.textContent = navigator.userAgent;
        
        // 初始检测
        checkDisplayMode();
        
        // 监听每种显示模式的变化
        displayModes.forEach(mode => {
          const mediaQuery = window.matchMedia(`(display-mode: ${mode.name})`);
          
          // 使用现代浏览器的addEventListener
          mediaQuery.addEventListener("change", (e) => {
            if (e.matches) {
              checkDisplayMode();
            }
          });
        });
        
        // 监听beforeinstallprompt事件
        window.addEventListener("beforeinstallprompt", (e) => {
          // 阻止Chrome 67+自动显示安装提示
          e.preventDefault();
          // 保存事件以便稍后触发
          deferredPrompt = e;
          isInstallable = true;
          updateUI();
        });
        
        // 应用安装后隐藏安装按钮
        window.addEventListener("appinstalled", () => {
          deferredPrompt = null;
          isInstallable = false;
          updateUI();
        });
        
        // 可见性变化时也检查
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") {
            checkDisplayMode();
          }
        });

        // 刷新按钮点击事件
        refreshButton.addEventListener('click', () => {
          refreshButton.classList.add('animate-spin');
          checkDisplayMode();
          setTimeout(() => {
            refreshButton.classList.remove('animate-spin');
          }, 500);
        });

        // 安装按钮点击事件
        installButton.querySelector('button').addEventListener('click', () => {
          if (deferredPrompt) {
            // 显示安装提示
            deferredPrompt.prompt();
            
            // 等待用户响应提示
            deferredPrompt.userChoice.then((choiceResult) => {
              if (choiceResult.outcome === "accepted") {
                console.log("用户接受了安装提示");
              } else {
                console.log("用户拒绝了安装提示");
              }
              // 清除保存的提示
              deferredPrompt = null;
              isInstallable = false;
              updateUI();
            });
          }
        });
      }

      // 在页面加载完成后初始化
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>